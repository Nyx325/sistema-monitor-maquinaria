<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gráfico Reporte</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="alert" class="alert alert-danger d-none"></div>
    <form>
      <!-- Elementos HTML para la entrada de datos -->
      <label for="start-date">Fecha de inicio</label>
      <input type="date" id="start-date" required />

      <label for="end-date">Fecha de fin</label>
      <input type="date" id="end-date" required />

      <label for="days-difference">Días de diferencia</label>
      <input type="number" id="days-difference" required />

      <button id="summit-btn" type="button">Generar Reporte</button>
    </form>

    <!-- Contenedor para los gráficos -->
    <div id="charts-container"></div>

    <script type="module">
      class ReportAdapter {
        constructor() {
          this.apiUrl = `${document.location.host}/api`;
        }

        async getData(startDate, endDate, daysDifference) {
          const response = await fetch(
            `http://${this.apiUrl}/reportes/1?startDate=${startDate}&endDate=${endDate}&daysDifference=${daysDifference}`,
          );

          const data = await response.json();

          if (response.status >= 400) throw Error(data.message);

          const labels = data.map((item) => item.dateRange);
          const cohAvgData = data.map((item) => item.cohAvg);
          const fuelUsedAvgData = data.map((item) => item.fuelUsedAvg);
          const odometerAvgData = data.map((item) => item.odometerAvg);
          const idleHoursAverageData = data.map(
            (item) => item.idleHoursAverage,
          );
          const fuelRemainingAverageData = data.map(
            (item) => item.fuelRemainingAverage,
          );
          const defRemainingAverageData = data.map(
            (item) => item.defRemainingAverage,
          );

          return [
            {
              chartId: "cohAvgChart",
              title: "Horas operativas acumuladas",
              data: {
                labels,
                datasets: [
                  {
                    label: "Horas operativas acumuladas",
                    data: cohAvgData,
                    borderColor: "rgba(255, 99, 132, 1)",
                    backgroundColor: "rgba(255, 99, 132, 0.2)",
                    fill: true,
                  },
                ],
              },
            },
            {
              chartId: "fuelUsedChart",
              title: "Combustible usado",
              data: {
                labels,
                datasets: [
                  {
                    label: "Combustible usado",
                    data: fuelUsedAvgData,
                    borderColor: "rgba(54, 162, 235, 1)",
                    backgroundColor: "rgba(54, 162, 235, 0.2)",
                    fill: true,
                  },
                ],
              },
            },
            {
              chartId: "odometerChart",
              title: "Odómetro",
              data: {
                labels,
                datasets: [
                  {
                    label: "Odómetro",
                    data: odometerAvgData,
                    borderColor: "rgba(75, 192, 192, 1)",
                    backgroundColor: "rgba(75, 192, 192, 0.2)",
                    fill: true,
                  },
                ],
              },
            },
            {
              chartId: "idleHoursChart",
              title: "Horas inactivas acumuladas",
              data: {
                labels,
                datasets: [
                  {
                    label: "Horas inactivas acumuladas",
                    data: idleHoursAverageData,
                    borderColor: "rgba(153, 102, 255, 1)",
                    backgroundColor: "rgba(153, 102, 255, 0.2)",
                    fill: true,
                  },
                ],
              },
            },
            {
              chartId: "fuelRemainingChart",
              title: "Combustible restante",
              data: {
                labels,
                datasets: [
                  {
                    label: "Combustible restante",
                    data: fuelRemainingAverageData,
                    borderColor: "rgba(255, 159, 64, 1)",
                    backgroundColor: "rgba(255, 159, 64, 0.2)",
                    fill: true,
                  },
                ],
              },
            },
            {
              chartId: "defRemainingChart",
              title: "DEF Restante",
              data: {
                labels,
                datasets: [
                  {
                    label: "DEF Restante",
                    data: defRemainingAverageData,
                    borderColor: "rgba(255, 205, 86, 1)",
                    backgroundColor: "rgba(255, 205, 86, 0.2)",
                    fill: true,
                  },
                ],
              },
            },
          ];
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const startDayI = document.getElementById("start-date");
        const endDayI = document.getElementById("end-date");
        const daysDifferenceI = document.getElementById("days-difference");
        const summitBtn = document.getElementById("summit-btn");
        const alert = document.getElementById("alert");
        const reportAdapter = new ReportAdapter();

        summitBtn.addEventListener("click", () => {
          const start = startDayI.value.trim();
          const end = endDayI.value.trim();
          const days = daysDifferenceI.value.trim();

          reportAdapter
            .getData(start, end, Number(days))
            .then((chartsData) => {
              const container = document.getElementById("charts-container");

              // Limpiar gráficos anteriores
              container.innerHTML = "";

              chartsData.forEach(({ chartId, title, data }) => {
                // Crear un nuevo canvas
                const canvas = document.createElement("canvas");
                canvas.id = chartId;
                canvas.style.marginBottom = "20px";
                container.appendChild(canvas);

                // Crear el gráfico
                const ctx = canvas.getContext("2d");
                new Chart(ctx, {
                  type: "line",
                  data: data,
                  options: {
                    responsive: true,
                    plugins: {
                      legend: { position: "top" },
                      title: {
                        display: true,
                        text: title,
                      },
                    },
                    scales: {
                      x: {
                        ticks: {
                          callback: (value) => data.labels[value],
                          maxRotation: 90,
                          minRotation: 90,
                        },
                      },
                    },
                  },
                });
              });
              alert.classList.add("d-none");
            })
            .catch((e) => {
              console.error(e);
              alert.innerHTML = e.message;
              alert.classList.remove("d-none");
            });
        });
      });
    </script>
  </body>
</html>
